use 'sake-outdated'
use 'sake-publish'
use 'sake-version'

fs    = require 'fs'
path  = require 'path'
mkdir = require 'mkdirp-sync'
read  = require 'read-yaml'
write = require 'write-data'

specs =
  commerce: '5adf8f9c47d5e7000382e297'
  identity: '5adf8fa75620ce0003495003'

task 'clean', 'clean project', ->
  exec 'rm -rf build'

task 'build', 'build project', ->
  mkdir 'build'

  for k of specs
    yaml = read.sync "#{spec}/#{spec}.yaml"
    yaml.definitions = {}
    yaml.paths       = {}

    for file in fs.readdirSync spec
      api = read.sync path.join spec, file
      for k,v of api.paths
        yaml.paths[k] = v
      for k,v of api.definitions
        yaml.definitions[k] = v
      write.sync "build/#{spec}.json", yaml

task 'publish', 'publish api specs', ->
  for spec, id of specs
    token = process.env.READMEIO_TOKEN
    token += "-#{id}" if id
    exec.sync "rdme swagger build/#{spec}.json --token=#{token}"
